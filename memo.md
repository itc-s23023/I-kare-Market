# フリマアプリ 処理追跡と課題メモ

## 🔨 オークション機能

**追跡日**: 2025-11-18  
**対象ファイル**: `app/auctions/[id]/page.tsx`, `hooks/useAuctions.ts`, `app/chat/[productId]/page.tsx`

### 課題1: 落札後の取引確定フローが曖昧
- **現状**: 落札者決定後、チャットでの成約・評価フローはフリマと共通化されたが、UI上で「落札確定」や「支払い」などの明示的なアクションが弱い。
- **影響**: ユーザーが「いつ・どのタイミングで」取引が成立したか分かりづらく、トラブル時の説明責任が果たしにくい。

### 課題2: 入札キャンセル・無効化の仕組みが未実装
- **現状**: 一度入札した後のキャンセルや、出品者による入札無効化のUI/ロジックがない。
- **影響**: 誤入札やトラブル時の救済措置がなく、ユーザー体験に課題。

### 課題3: 評価未送信時の取引証跡欠落
- **現状**: フリマ同様、評価を送信しないまま離脱した場合に履歴が残らない。
- **影響**: 取引証跡・評価が欠落し、ユーザーの信頼性担保に課題。

### 課題4: 入札中のオークション編集制限がない
- **現状**: `/auctions/[id]/edit/page.tsx` では、入札数やステータスに関わらず編集が可能。開始価格・終了日時・商品情報を入札中に変更できてしまう。
- **影響**: 入札者が不利益を被る可能性があり、フェアなオークション運営ができない。入札がある場合は編集を制限するか、編集可能項目を大幅に制限すべき。

### 課題5: 時間切れ後に最高入札者がチャットへ遷移できない
- **現状**: オークションが終了して最高入札者が決定しても、そのユーザーにチャット画面への導線（自動スレ生成・ディープリンク・通知）が未整備で、チャットに到達できない。
- **影響**: 成約連絡が滞り取引開始が遅延する。ユーザーがどこから連絡すべきか迷い、離脱やトラブルの温床となる。

---

## 🛒 出品フロー

**追跡日**: 2025-11-18  
**対象ファイル**: `app/sell/page.tsx`, `components/product-form.tsx`, `hooks/useProductUpload.ts`

### 課題1: 画像アップロード失敗時のリカバリが弱い
- **現状**: 画像アップロード失敗時のエラーハンドリングやリトライUIが未整備。
- **影響**: 出品途中で画像がアップロードできない場合、ユーザーがやり直しを強いられる。

### 課題2: 必須項目バリデーションの網羅性
- **現状**: 商品名・価格などのバリデーションはあるが、説明文やカテゴリ等の必須チェックが一部曖昧。
- **影響**: 不完全な商品情報で出品されるリスク。

---

## 🔑 認証・権限

**追跡日**: 2025-11-18  
**対象ファイル**: `components/auth-provider.tsx`, `app/login/page.tsx`

### 課題1: 未認証ユーザーのアクセス制御
- **現状**: 一部ページで未認証ユーザーが直接URLアクセスできてしまう可能性。
- **影響**: 本来制限すべき機能（出品・購入・チャット等）に不正アクセスされるリスク。

### 課題2: 管理者権限の設計不足
- **現状**: 管理者によるユーザー管理・商品削除等の権限設計が未整備。
- **影響**: 問題発生時の運用・対応が困難。

---

## 🖼️ 画像アップロード

**追跡日**: 2025-11-18  
**対象ファイル**: `components/image-upload.tsx`, `hooks/useProductUpload.ts`

### 課題1: 容量制限・ファイル形式チェックの明示
- **現状**: UI上でアップロード可能な容量・形式のガイドが弱い。
- **影響**: 大容量や非対応形式の画像でエラーになりやすい。

### 課題2: アップロード失敗時のUI/UX
- **現状**: 失敗時のエラー表示やリトライ導線が不十分。
- **影響**: ユーザーが原因不明のまま出品を諦めるケースが発生。

---

## 🔍 検索・フィルタ

**追跡日**: 2025-11-18  
**対象ファイル**: `app/page.tsx`, `components/listing.tsx`

### 課題1: 検索精度・フィルタ条件の保存
- **現状**: キーワード検索・カテゴリフィルタは実装済みだが、複数条件の組み合わせや直近の検索条件保存は未対応。
- **影響**: ユーザーが毎回条件を再入力する手間が発生。

### 課題2: 検索結果のソート・ページネーション
- **現状**: ソートやページ送りのUI/ロジックが限定的。
- **影響**: 商品数が増えた際の利便性・パフォーマンスに課題。
## 📦 購入フロー（商品チャット → 取引完了）

**追跡日**: 2025-11-14  
**対象ファイル**: `app/chat/[productId]/page.tsx`, `hooks/useChat.ts`, `hooks/usePurchase_history.ts`


### 課題2: 「売却済み」の表示とデータが一致しない
- **現状**: 取引完了時に商品ドキュメントを削除しており、`status: "sold"` が保存されない
- **影響**: 一覧や出品者ページで「売却済み」を正しく判定できず、共有URLが 404 になりやすい

### 課題5: 「購入確定」の明示が弱い
- **現状**: 双方同意の直後に評価送信＝成約。支払い・受け渡し・確定タイミングが曖昧
- **影響**: いつ誰が確定させたかのログが薄く、トラブル時の説明責任が果たしにくい

### 課題7: 評価を送信せずに離脱した場合
- **現状**: 双方同意後、購入者が評価を送信しないまま画面を離脱すると、取引が「完了」にならず、履歴や評価も残らない。
- **影響**: 取引証跡が欠落し、出品者の評価・購入履歴が更新されない。再度チャットにアクセスすれば続行できるが、ユーザー体験や運用上のトラブルリスクが残る。

---

## 🔧 今後の追跡予定

- オークション機能
- 出品フロー
- 認証・権限周り
- 画像アップロード
- 検索・フィルタ

---

## 📝 記録ルール

各セクションには以下を含めます:
- **追跡日**: いつ確認したか
- **対象ファイル**: 関連するファイルパス
- **課題N**: 簡潔なタイトルと現状・影響の説明